name: E2E Signing

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

permissions:
  contents: read
  packages: write
  id-token: write # Required for Sigstore keyless signing

jobs:
  e2e-signing:
    name: E2E Signing Test
    runs-on: ubuntu-latest
    # Skip for external PRs (no OIDC token available)
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"

      - name: Build CLI
        run: go build -o blobber ./cmd/blobber

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create test files
        run: |
          mkdir -p testdata/e2e
          echo "E2E test content - $(date -u +%Y-%m-%dT%H:%M:%SZ)" > testdata/e2e/file.txt
          echo "Additional test file" > testdata/e2e/another.txt

      - name: Push with signing
        run: |
          ./blobber push ./testdata/e2e \
            ghcr.io/${{ github.repository }}/e2e-test:${{ github.sha }} \
            --sign \
            --verbose

      - name: Pull with verification
        run: |
          rm -rf output
          ./blobber pull \
            ghcr.io/${{ github.repository }}/e2e-test:${{ github.sha }} \
            ./output \
            --verify \
            --verify-issuer "https://token.actions.githubusercontent.com" \
            --verify-subject "https://github.com/${{ github.repository }}/.github/workflows/e2e-signing.yml@${{ github.ref }}" \
            --verbose

      - name: Verify content
        run: |
          echo "Comparing files..."
          diff testdata/e2e/file.txt output/file.txt
          diff testdata/e2e/another.txt output/another.txt
          echo "âœ“ Round-trip with signing/verification succeeded"

name: E2E Signing

on:
  push:
    branches: [master]

# Ensure only one signing workflow runs at a time to maintain consistent tag state
concurrency:
  group: e2e-signing
  cancel-in-progress: false

permissions:
  contents: read
  packages: write
  id-token: write # Required for Sigstore keyless signing

jobs:
  e2e-signing:
    name: E2E Signing Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build CLI
        run: go build -o blobber ./cmd/blobber

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create test files
        run: |
          mkdir -p testdata/e2e
          echo "E2E test content - $(date -u +%Y-%m-%dT%H:%M:%SZ)" > testdata/e2e/file.txt
          echo "Additional test file" > testdata/e2e/another.txt

      - name: Push with signing
        run: |
          ./blobber push ./testdata/e2e \
            ghcr.io/${{ github.repository }}/e2e-test:latest \
            --sign \
            --verbose

      - name: Pull with verification
        run: |
          rm -rf output
          ./blobber pull \
            ghcr.io/${{ github.repository }}/e2e-test:latest \
            ./output \
            --verify \
            --verify-issuer "https://token.actions.githubusercontent.com" \
            --verify-subject "https://github.com/${{ github.repository }}/.github/workflows/e2e-signing.yml@refs/heads/master" \
            --verbose

      - name: Verify content
        run: |
          echo "Comparing files..."
          diff testdata/e2e/file.txt output/file.txt
          diff testdata/e2e/another.txt output/another.txt
          echo "Round-trip with signing/verification succeeded"
